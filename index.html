<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•å‹•ç‰©èŠ±è—äº¤æ›æ´¾å°</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { 
            font-family: 'Microsoft JhengHei', 'Helvetica', sans-serif; 
            background-color: #fdf5e6; 
            color: #4a4a4a; margin: 0; padding: 0; line-height: 1.6;
        }
        .container { 
            max-width: 600px; margin: 0 auto; background: white; 
            min-height: 100vh; position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        header { background-color: #2c5e2e; color: white; padding: 30px 20px; text-align: center; }
        h1 { margin: 0; font-size: 24px; letter-spacing: 2px; }
        .subtitle { font-size: 14px; opacity: 0.9; margin-top: 10px; }
        
        section { padding: 30px 20px; border-bottom: 1px solid #eee; }
        h2 { 
            color: #2c5e2e; font-size: 20px; margin-bottom: 20px; 
            border-left: 5px solid #c0392b; padding-left: 10px;
        }
        .hidden { display: none !important; }

        /* --- è§’è‰²å¡ç‰‡ --- */
        .role-list { display: flex; flex-direction: column; gap: 15px; }
        .role-card {
            display: flex; align-items: flex-start; border: 2px solid #eee; border-radius: 12px;
            padding: 15px; cursor: pointer; transition: 0.2s; background: #fff;
        }
        .role-card.selected { border-color: #c0392b; background-color: #fff5f5; }
        .role-card.disabled { opacity: 0.6; background-color: #f9f9f9; cursor: not-allowed; filter: grayscale(1); pointer-events: none; }
        .role-icon { font-size: 40px; margin-right: 15px; flex-shrink: 0; }
        .role-info h3 { margin: 0 0 5px 0; font-size: 18px; color: #333; }
        .role-desc { font-size: 13px; color: #666; margin: 0; text-align: justify; }

        /* --- èŠ±è—å¯¦é©—å®¤ --- */
        .canvas-container { 
            position: relative; width: 100%; height: 350px; 
            background-color: #fffaf0; border: 2px dashed #2c5e2e; border-radius: 10px; 
            margin-bottom: 15px; overflow: hidden; 
        }
        .flower-assets { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; }
        
        /* ç´ ææŒ‰éˆ•æ¨£å¼ */
        .asset-item { 
            width: 70px; height: 95px; 
            border: 1px solid #ddd; border-radius: 8px; 
            cursor: pointer; flex-shrink: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; background: #fff;
            position: relative; padding: 5px; box-sizing: border-box;
        }
        .asset-item img { width: 40px; height: 40px; object-fit: contain; margin-bottom: 5px; }
        .asset-info { font-size: 10px; color: #666; text-align: center; line-height: 1.2; width: 100%; overflow: hidden; }
        .asset-item.disabled { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; pointer-events: none; }
        .asset-count { color: #c0392b; font-weight: bold; margin-top: 2px; }

        /* ç•«å¸ƒä¸Šçš„èŠ± */
        .draggable-item { 
            position: absolute; cursor: move; user-select: none; 
            width: 80px; height: 80px; 
        }
        .draggable-item img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        /* --- è¡¨å–®æ§åˆ¶ --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        select, input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; }
        select option:disabled { color: #ccc; background-color: #f5f5f5; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { padding: 20px; display: flex; gap: 10px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none; display: inline-block; }
        .btn-primary { background-color: #c0392b; color: white; box-shadow: 0 4px 15px rgba(192, 57, 43, 0.4); }
        .btn-primary:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }
        .btn-secondary { background-color: #eee; color: #555; }
        .btn-apple { background-color: #000; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* --- é¸é … Radio (å…±ç”¨) --- */
        .radio-group { display: flex; gap: 15px; margin-bottom: 20px; }
        .radio-option { flex: 1; border: 2px solid #ddd; border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; font-size: 15px;}
        .radio-option.active { border-color: #2c5e2e; background-color: #eafaf1; color: #2c5e2e; font-weight: bold; }
        .radio-option input { display: none; }
        
        .method-block { padding: 20px; background: #f9f9f9; border-radius: 10px; border: 1px solid #eee; margin-top: 15px; }
        
        /* è­¦èªæ¨£å¼ */
        .warning-text { color: #c0392b; font-size: 13px; font-weight: bold; margin-top: 5px; background: #fadbd8; padding: 8px; border-radius: 5px; }

        /* åœ°åœ–å®¹å™¨ */
        .map-container {
            width: 100%;
            height: 250px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            border: 1px solid #ddd;
        }
        .map-container iframe { width: 100%; height: 100%; border: 0; }
        
        /* éŠ€è¡Œè³‡è¨Šæ–‡å­— */
        .bank-info { font-size: 14px; color: #333; background: #fff; padding: 15px; border-radius: 8px; border: 1px dashed #aaa; margin-bottom: 15px; line-height: 1.8; }
        .bank-info strong { color: #2c5e2e; }

        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 999; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div style="font-size:40px;">â³</div>
    <p>æ­£åœ¨åŒæ­¥èŠ±æåº«å­˜...</p>
</div>

<div class="container">
    <header>
        <h1>è–èª•å‹•ç‰©èŠ±è—äº¤æ› ğŸŒ¸</h1>
        <div class="subtitle" id="header-subtitle">Step 1: æŒ‘é¸è§’è‰²èˆ‡è¨­è¨ˆèŠ±æŸ</div>
    </header>

    <div id="phase-game">
        <section>
            <h2>1. è«‹å•ä½ æ˜¯å“ªä½å‹•ç‰©ï¼Ÿ</h2>
            <div id="role-list" class="role-list"></div>
        </section>
        <section>
            <h2>2. äº¤æ›å¿ƒé¡˜</h2>
            <div class="form-group">
                <label>ä½ å¸Œæœ›æ”¶åˆ°èª°é…çš„èŠ±ï¼Ÿ</label>
                <select id="receive-select" onchange="updateMutualExclusion()"><option value="">è«‹é¸æ“‡...</option></select>
            </div>
            <div class="form-group">
                <label>ä½ æƒ³æŠŠä½ çš„èŠ±é€çµ¦èª°ï¼Ÿ</label>
                <select id="give-select" onchange="updateMutualExclusion()"><option value="">è«‹é¸æ“‡...</option></select>
            </div>
        </section>
        <section>
            <h2>3. èŠ±è—å¯¦é©—å®¤ ğŸ¨</h2>
            <p style="font-size:13px; color:#666; margin-top:-10px;">è«‹å°‡èŠ±ææ‹–å…¥æ¡†ä¸­ï¼Œå‰©é¤˜æ•¸é‡æ­¸é›¶å‰‡ç„¡æ³•é¸å–ã€‚</p>
            
            <div class="canvas-container" id="flower-canvas">
                <span style="position:absolute; top:45%; width:100%; text-align:center; color:#ccc; pointer-events:none;">æ‹–æ›³èŠ±æåˆ°é€™è£¡</span>
            </div>
            
            <div class="flower-assets" id="asset-list"></div>
            
            <button onclick="clearCanvas()" style="margin-top:10px; background:none; border:1px solid #ccc; padding:5px 10px; border-radius:15px; font-size:12px;">æ¸…ç©ºé‡ä¾†</button>
        </section>
        <section>
            <h2>4. å¯«ä¸‹ç¥ç¦</h2>
            <div class="form-group">
                <textarea id="msg-input" rows="4" placeholder="å¯«ä¸‹æš–å¿ƒçš„è©±..."></textarea>
            </div>
        </section>
        <div class="btn-group">
            <button id="btn-next" class="btn btn-primary">ä¸‹ä¸€æ­¥ï¼šå¡«å¯«è³‡æ–™ â¡ï¸</button>
        </div>
    </div>

    <div id="phase-info" class="hidden">
        <section>
            <h2>5. é¸æ“‡å–èŠ±æ–¹å¼</h2>
            <div class="radio-group">
                <label class="radio-option active" id="opt-self" onclick="toggleMethod('self')">
                    <input type="radio" name="deliveryMethod" value="è‡ªå–" checked> ğŸ¢ äººæ€§ç©ºé–“è‡ªå–
                </label>
                <label class="radio-option" id="opt-delivery" onclick="toggleMethod('delivery')">
                    <input type="radio" name="deliveryMethod" value="é‹é€"> ğŸšš å°ˆè»Šé‹é€ (+120)
                </label>
            </div>

            <div id="block-self" class="method-block">
                <div class="form-group">
                    <label>é è¨ˆè‡ªå–æ™‚æ®µ (12/26)ï¼š</label>
                    <select id="self-time">
                        <option value="">è«‹é¸æ“‡æ™‚æ®µ...</option>
                        <option value="12/26 16:00-16:30">12/26 16:00-16:30</option>
                        <option value="12/26 16:30-17:00">12/26 16:30-17:00</option>
                        <option value="12/26 17:00-17:30">12/26 17:00-17:30</option>
                        <option value="12/26 17:30-18:00">12/26 17:30-18:00</option>
                        <option value="12/26 18:00-18:30">12/26 18:00-18:30</option>
                        <option value="12/26 18:30-19:00">12/26 18:30-19:00</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åœ°é»ï¼šäººæ€§ç©ºé–“ (å…¬é¤¨)</label>
                    <div class="map-container">
                        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3615.5362987463027!2d121.52953877606447!3d25.015867739020116!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3442a98b9b1e8b3f%3A0xfc84591eb30f101d!2sHuman%20Space%20Roosevelt!5e0!3m2!1sen!2stw!4v1765880890366!5m2!1sen!2stw" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"></iframe>
                    </div>
                </div>
            </div>

            <div id="block-delivery" class="method-block hidden">
                <div class="warning-text">âš ï¸ å¸æ©ŸæŠµé”æœƒé›»è©±è¯ç¹«ï¼Œè«‹å‹™å¿…åœ¨é›»è©±å¾Œ 15 åˆ†é˜å…§å–è²¨ï¼</div>
                <div class="form-group" style="margin-top:15px;">
                    <label>é…é€åœ°å€ (é™ä¸­æ­£ã€å¤§å®‰ã€ä¿¡ç¾©å€)ï¼š</label>
                    <input type="text" id="delivery-address" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€...">
                </div>
                <div class="form-group">
                    <label>å¸Œæœ›é…é€æ™‚æ®µï¼š</label>
                    <select id="delivery-time">
                        <option value="">è«‹é¸æ“‡æ™‚æ®µ...</option>
                        <option value="12/26 ä¸‹åˆ A (13:00-15:00)">12/26 ä¸‹åˆ A (13:00-15:00)</option>
                        <option value="12/26 ä¸‹åˆ B (15:00-17:00)">12/26 ä¸‹åˆ B (15:00-17:00)</option>
                        <option value="12/26 æ™šä¸Š C (18:00-20:00)">12/26 æ™šä¸Š C (18:00-20:00)</option>
                    </select>
                </div>
            </div>
        </section>

        <section>
            <h2>6. è¯çµ¡è³‡æ–™</h2>
            <div class="form-group">
                <label>ä½ çš„ Email (èº«ä»½è­˜åˆ¥ç”¨)ï¼š</label>
                <input type="email" id="email-input" placeholder="example@gmail.com">
            </div>
            <div class="form-group">
                <label>æ‰‹æ©Ÿè™Ÿç¢¼ (é…é€/è‡ªå–è¯çµ¡ç”¨)ï¼š</label>
                <input type="tel" id="phone-input" placeholder="0912-345-678">
            </div>
            <div class="form-group">
                <label>é ˜èŠ±æš±ç¨±ï¼š</label>
                <input type="text" id="name-input" placeholder="ä¾‹å¦‚ï¼šå°æ˜">
            </div>
        </section>

        <section>
            <h2>7. åŒ¯æ¬¾è³‡è¨Š</h2>
            
            <div class="radio-group">
                <label class="radio-option active" id="pay-opt-bank" onclick="togglePayment('bank')">
                    <input type="radio" name="paymentMethod" value="bank" checked> ğŸ¦ éŠ€è¡ŒåŒ¯æ¬¾
                </label>
                <label class="radio-option" id="pay-opt-apple" onclick="togglePayment('apple')">
                    <input type="radio" name="paymentMethod" value="apple"> ğŸ Apple Pay
                </label>
            </div>

            <div id="block-bank">
                <div class="bank-info">
                    éŠ€è¡Œï¼š<strong>åœ‹æ³°ä¸–è¯ (013)</strong><br>
                    å¸³è™Ÿï¼š<strong>105501316365</strong><br>
                    å‚™è¨»è«‹å¡«ï¼š<strong>FlowerFriday 5</strong>
                </div>
                <div class="form-group">
                    <label>åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼ï¼š</label>
                    <input type="text" id="pay-input" placeholder="12345">
                </div>
            </div>

            <div id="block-apple" class="hidden" style="text-align: center;">
                <p style="margin-bottom: 15px; color: #555;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•å°‡é–‹å•Ÿæ–°åˆ†é é€²è¡Œä»˜æ¬¾ã€‚</p>
                <a href="https://trustpay.hitrust.com.tw/TRUSTPAY/EasyPay2?checktoken=6b888f9863f5175d3f589259145c513fd668092d&storeid=6N632" target="_blank" class="btn btn-apple">
                    ï£¿ Pay with Apple Pay
                </a>
                <p style="margin-top: 15px; font-size: 13px; color: #888;">ä»˜æ¬¾å®Œæˆå¾Œï¼Œè«‹ç›´æ¥æŒ‰ä¸‹æ–¹ã€Œç¢ºèªå ±åã€å³å¯ã€‚</p>
            </div>
        </section>

        <div class="btn-group">
            <button id="btn-back" class="btn btn-secondary">â¬…ï¸ è¿”å›</button>
            <button id="btn-submit" class="btn btn-primary">ç¢ºèªå ±å</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ è¨­å®šå€ï¼šè«‹æ›æˆä½ çš„ Google Apps Script ç¶²å€
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbxyobOzz0lMOeSkvfOg2sR4IsNzM2MFTbNUHtIkxZZwO8aIZ3B9OflAUlRqRdqrJFtHwQ/exec"; // è«‹æ›å›ä½ çœŸæ­£çš„ç¶²å€
    
    // èŠ±æåœ–ç‰‡è®€å–å¤±æ•—æ™‚çš„æ›¿ä»£ Icon
    const FALLBACK_ICON = "https://placehold.co/80x80/eee/999?text=ğŸŒ¸";

    // è§’è‰²è¨­å®š
    const CHARACTER_DESC = [
        { id: 'rabbit', icon: 'ğŸ°', name: 'å›ºåŸ·çš„å…”å­', desc: 'æœ‰è—è‰²çœ¼ç›ï¼Œä¸å–œæ­¡åƒè¶…éå…«å…¬åˆ†çš„èƒ¡è˜¿è””ï¼Œå–œæ­¡åœ¨é›²å±¤å¾ˆåšçš„æ™‚å€™ä¸Šå»æ‰€ï¼Œç„¡èŠçš„æ™‚å€™å–œæ­¡ç®—å¡”ç¾…ã€‚' },
        { id: 'lion', icon: 'ğŸ¦', name: 'æµªæ¼«çš„ç…å­', desc: 'é’å£¯å¹´ï¼Œæœ‰è‘—æ¯”å¤§éƒ¨åˆ†ç…å­é•·çš„å°¾å·´ã€‚å–œæ­¡åœ¨æ¨¹ä¸‹ä¹˜æ¶¼ï¼Œåœ¨ä¹˜æ¶¼çš„æ™‚å€™å–œæ­¡å¯«è©©ï¼Œä½†ä¸æœƒæ‹¿ç­†ã€‚' },
        { id: 'cat', icon: 'ğŸ±', name: 'ç²¾éˆçš„å°è²“', desc: 'æœ‰è‘—ç°é»‘è‰²çš„å¤§ç†çŸ³ç´‹ã€éŠ³åˆ©çš„çœ¼ç¥ï¼Œæ˜¯å‰›å‡ºç”Ÿä¸ä¹…çš„è²“å’ªå¯¶å¯¶ã€‚æœ€å–œæ­¡åƒçš„é£Ÿç‰©æ˜¯é®­é­šï¼Œå¤¢æƒ³æ˜¯å¯ä»¥è·³åˆ°ç…å­æ„›ä¹˜æ¶¼çš„æ¨¹ä¸Šï¼Œç„¶å¾Œå¾æ¨¹ä¸Šå¾€ä¸‹çœ‹ä»–ã€‚' },
        { id: 'elephant', icon: 'ğŸ˜', name: 'ç„¡æ†‚ç„¡æ…®çš„å¤§è±¡', desc: 'ç”Ÿæ€§æ¨‚è§€ã€æ²’æœ‰ç…©æƒ±ï¼Œæ‰€æœ‰çš„å‹•ç‰©éƒ½å–œæ­¡æ‰¾ä»–è«‡å¿ƒï¼Œä½†æ˜¯å¤©ç”Ÿåªæœ‰ä¸‰éš»è…³ã€‚æœ‰å€‹æ²’å‹•ç‰©çŸ¥é“çš„ç§˜å¯†æŠ€èƒ½æ˜¯æœƒèƒŒä¹ä¹ä¹˜æ³•è¡¨ã€‚' },
        { id: 'owl', icon: 'ğŸ¦‰', name: 'å°‘ä¸€æ ¹è–çš„è²“é ­é·¹', desc: 'é•·å¾—å¾ˆå¸¥ã€å–œæ­¡åƒè¾£ã€‚æœ€å–œæ­¡ç¡è¦ºçš„åœ°æ–¹æ˜¯å…”å­çª©é‚Šï¼Œå¦‚æœæ²’ä¸å°å¿ƒé£›éŒ¯çš„è©±ã€‚' },
        { id: 'penguin', icon: 'ğŸ§', name: 'ç†±æ„›ç’°ä¿çš„ä¼éµ', desc: 'èµ°è·¯å¾ˆæ…¢ã€ä¸æœƒæ¸¸æ³³ã€‚èˆˆè¶£æ˜¯ç™¼æ˜å¥½åƒçš„ç´ é£Ÿèœå–®ï¼Œå¸Œæœ›èœå–®å¯ä»¥ç²å¾—å›ºåŸ·å…”å­çš„èªå¯ï¼Œä¹Ÿå¸Œæœ›æœ‰ä¸€å¤©å¯ä»¥çœ‹åˆ°æ²’æœ‰åƒåœ¾çš„æµ·ç˜ã€‚' },
        // å®‰å…¨åé¡
        { id: 'koala', icon: 'ğŸ¨', name: 'æ„›çç„¡å°¾ç†Š', desc: 'ä¸€å¤©è¦ç¡20å€‹å°æ™‚ï¼Œé†’è‘—çš„æ™‚å€™éƒ½åœ¨ç™¼å‘†ã€‚' },
        { id: 'bear', icon: 'ğŸ»', name: 'æš–ç”·å¤§ç†Š', desc: 'å†¬å¤©æœƒæº–å‚™å¾ˆå¤šèœ‚èœœèŒ¶è«‹å¤§å®¶å–ã€‚' }
    ];

    let myRole = null;
    let serverData = {}; 
    let flowersData = []; 
    let usedFlowers = {}; 
    let savedImageBase64 = null;
    let currentMethod = 'è‡ªå–';
    let currentPayment = 'bank'; // è¨˜éŒ„ç›®å‰é¸æ“‡çš„ä»˜æ¬¾æ–¹å¼
    let globalZIndex = 100;

    // 1. åˆå§‹åŒ–
    window.onload = async function() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            serverData = data;
            flowersData = data.flowers || [];
            document.getElementById('loading').style.display = 'none';
            renderRoleList(data.roles);
            renderDropdowns();
            renderFlowerAssets();
        } catch (e) {
            console.error(e);
            alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é€£çµ");
        }
    };

    // --- æ¸²æŸ“èˆ‡é‚è¼¯ ---
    function renderFlowerAssets() {
        const container = document.getElementById('asset-list');
        container.innerHTML = '';
        flowersData.forEach(flower => {
            const div = document.createElement('div');
            const isSoldOut = flower.remaining <= 0;
            div.className = `asset-item ${isSoldOut ? 'disabled' : ''}`;
            if (!isSoldOut) div.onclick = () => addItem(flower);
            div.innerHTML = `
                <img src="${flower.url || FALLBACK_ICON}" alt="${flower.name}" onerror="this.src='${FALLBACK_ICON}'">
                <div class="asset-info"><div>${flower.name}</div><div class="asset-count">å‰© ${flower.remaining}</div></div>
            `;
            container.appendChild(div);
        });
    }

    function renderRoleList(sheetData) {
        const container = document.getElementById('role-list');
        container.innerHTML = '';
        CHARACTER_DESC.forEach(char => {
            const status = sheetData.find(d => d.id === char.id);
            const isTaken = status ? status.taken : false;
            const card = document.createElement('div');
            card.className = `role-card ${isTaken ? 'disabled' : ''}`;
            if (!isTaken) card.onclick = () => selectRole(card, char.id);
            let html = `<div class="role-icon">${char.icon}</div><div class="role-info"><h3>${char.name}</h3><p class="role-desc">${char.desc}</p></div>`;
            if(isTaken) html += '<div style="margin-left:auto; color:red; font-size:12px; font-weight:bold;">(å·²é¡æ»¿)</div>';
            card.innerHTML = html;
            container.appendChild(card);
        });
    }

    function renderDropdowns() {
        const rSelect = document.getElementById('receive-select');
        const gSelect = document.getElementById('give-select');
        const oldR = rSelect.value;
        const oldG = gSelect.value;
        rSelect.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
        gSelect.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
        CHARACTER_DESC.forEach(char => {
            const isSelf = (myRole === char.id);
            const isBusyProvider = serverData.busyProviders ? serverData.busyProviders.includes(char.id) : false;
            const isBusyReceiver = serverData.busyReceivers ? serverData.busyReceivers.includes(char.id) : false;
            let rOption = document.createElement('option'); rOption.value = char.id; rOption.text = char.icon + " " + char.name; rOption.dataset.text = rOption.text;
            if (isSelf || isBusyProvider) { rOption.disabled = true; rOption.text += isSelf?" (ä½ è‡ªå·±)":" (å·²è¢«é ç´„)"; rOption.dataset.locked="true"; }
            rSelect.appendChild(rOption);
            let gOption = document.createElement('option'); gOption.value = char.id; gOption.text = char.icon + " " + char.name; gOption.dataset.text = gOption.text;
            if (isSelf || isBusyReceiver) { gOption.disabled = true; gOption.text += isSelf?" (ä½ è‡ªå·±)":" (å·²æœ‰äººé€)"; gOption.dataset.locked="true"; }
            gSelect.appendChild(gOption);
        });
        if(oldR) rSelect.value = oldR;
        if(oldG) gSelect.value = oldG;
        updateMutualExclusion();
    }

    function updateMutualExclusion() {
        const rSelect = document.getElementById('receive-select');
        const gSelect = document.getElementById('give-select');
        const rVal = rSelect.value;
        const gVal = gSelect.value;
        Array.from(rSelect.options).forEach(o=>{if(o.value===""){return;} if(!o.dataset.locked) { o.disabled=(o.value==gVal && gVal!==""); o.text=o.disabled?o.dataset.text+" (ä¸èƒ½é‡è¤‡é¸)":o.dataset.text; }});
        Array.from(gSelect.options).forEach(o=>{if(o.value===""){return;} if(!o.dataset.locked) { o.disabled=(o.value==rVal && rVal!==""); o.text=o.disabled?o.dataset.text+" (ä¸èƒ½é‡è¤‡é¸)":o.dataset.text; }});
    }

    function selectRole(el, id) {
        document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); myRole = id; renderDropdowns();
    }

    // --- åˆ‡æ›é‚è¼¯ ---
    function toggleMethod(m) {
        document.getElementById('opt-self').classList.toggle('active', m=='self');
        document.getElementById('opt-delivery').classList.toggle('active', m=='delivery');
        document.getElementById('block-self').classList.toggle('hidden', m!='self');
        document.getElementById('block-delivery').classList.toggle('hidden', m!='delivery');
        currentMethod = m=='self'?'è‡ªå–':'é‹é€';
    }

    function togglePayment(p) {
        document.getElementById('pay-opt-bank').classList.toggle('active', p=='bank');
        document.getElementById('pay-opt-apple').classList.toggle('active', p=='apple');
        document.getElementById('block-bank').classList.toggle('hidden', p!='bank');
        document.getElementById('block-apple').classList.toggle('hidden', p!='apple');
        currentPayment = p;
    }

    // --- èŠ±è—ç•«å¸ƒ ---
    const canvas = document.getElementById('flower-canvas');
    function addItem(flower) {
        if (usedFlowers[flower.id] && (usedFlowers[flower.id] >= flower.remaining)) {
            alert("é€™å€‹èŠ±æçš„åº«å­˜ç”¨å®Œäº†å–”ï¼"); return;
        }
        const el = document.createElement('div'); el.className = 'draggable-item';
        const img = document.createElement('img');
        img.src = flower.url || FALLBACK_ICON;
        img.onerror = function() { this.src = FALLBACK_ICON; this.onerror = null; };
        el.appendChild(img);
        el.style.left = (Math.random() * 60 + 10) + '%'; el.style.top = (Math.random() * 60 + 10) + '%';
        if (!usedFlowers[flower.id]) usedFlowers[flower.id] = 0; usedFlowers[flower.id]++;
        makeDraggable(el); canvas.appendChild(el);
    }
    function makeDraggable(el) {
        let isDragging = false;
        const start = (e) => { isDragging = true; globalZIndex++; el.style.zIndex = globalZIndex; };
        const move = (e) => {
            if(!isDragging) return; e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = canvas.getBoundingClientRect();
            el.style.left = (clientX - rect.left - 40) + 'px'; el.style.top = (clientY - rect.top - 40) + 'px';
        };
        const end = () => isDragging = false;
        el.addEventListener('mousedown', start); el.addEventListener('touchstart', start);
        document.addEventListener('mousemove', move); document.addEventListener('touchmove', move, { passive: false });
        document.addEventListener('mouseup', end); document.addEventListener('touchend', end);
    }
    function clearCanvas() { canvas.innerHTML = '<span style="position:absolute; top:45%; width:100%; text-align:center; color:#ccc; pointer-events:none;">æ‹–æ›³èŠ±æåˆ°é€™è£¡</span>'; usedFlowers = {}; }

    // --- é€å‡ºé‚è¼¯ ---
    document.getElementById('btn-next').onclick = async () => {
        if (!myRole) return alert("è«‹å…ˆé¸è§’è‰²ï¼");
        if (!document.getElementById('receive-select').value) return alert("è«‹é¸é…å°ï¼");
        if (!document.getElementById('msg-input').value) return alert("è«‹å¯«ç¥ç¦ï¼");
        
        const btn = document.getElementById('btn-next');
        const txt = btn.innerText; btn.innerText="ğŸ’¾ æ­£åœ¨å„²å­˜è¨­è¨ˆ..."; btn.disabled=true;
        try {
            const capture = await html2canvas(canvas, { scale: 2, useCORS: true });
            savedImageBase64 = capture.toDataURL("image/png");
            document.getElementById('phase-game').classList.add('hidden');
            document.getElementById('phase-info').classList.remove('hidden');
            document.getElementById('header-subtitle').innerText = "Step 2: å¡«å¯«è³‡æ–™";
            window.scrollTo(0,0);
        } catch(e) { alert("æˆªåœ–å¤±æ•—:" + e); } finally { btn.innerText=txt; btn.disabled=false; }
    };

    document.getElementById('btn-back').onclick = () => {
        document.getElementById('phase-info').classList.add('hidden');
        document.getElementById('phase-game').classList.remove('hidden');
        document.getElementById('header-subtitle').innerText = "Step 1: æŒ‘é¸è§’è‰²èˆ‡è¨­è¨ˆèŠ±æŸ";
        window.scrollTo(0,0);
    };

    document.getElementById('btn-submit').onclick = async () => {
        const email = document.getElementById('email-input').value;
        const phone = document.getElementById('phone-input').value;
        const name = document.getElementById('name-input').value;
        const msg = document.getElementById('msg-input').value;
        
        // å–è²¨æ–¹å¼é©—è­‰
        let pTime = "", addr = "";
        if(currentMethod==='è‡ªå–') {
            pTime = document.getElementById('self-time').value;
            if(!pTime) return alert("è«‹é¸æ“‡è‡ªå–æ™‚æ®µï¼");
            addr = "äººæ€§ç©ºé–“ (è‡ªå–)";
        } else {
            pTime = document.getElementById('delivery-time').value;
            addr = document.getElementById('delivery-address').value;
            if(!addr) return alert("è«‹è¼¸å…¥é…é€åœ°å€ï¼");
            if(!pTime) return alert("è«‹é¸æ“‡é…é€æ™‚æ®µï¼");
        }

        // ä»˜æ¬¾æ–¹å¼é©—è­‰èˆ‡è™•ç†
        let finalPaymentInfo = "";
        if (currentPayment === 'bank') {
            const bankCode = document.getElementById('pay-input').value;
            if(!bankCode) return alert("è«‹å¡«å¯«åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼ï¼");
            finalPaymentInfo = "æœ«äº”ç¢¼: " + bankCode;
        } else {
            // Apple Pay ä¸ç”¨æª¢æŸ¥æœ«äº”ç¢¼
            finalPaymentInfo = "Apple Pay (ä½¿ç”¨è€…å›å ±å·²ä»˜æ¬¾)";
        }

        if(!email || !name) return alert("è«‹å¡«å¯«å®Œæ•´è¯çµ¡è³‡æ–™ï¼");
        if(!phone) return alert("è«‹å¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼ï¼");

        const btn = document.getElementById('btn-submit');
        const txt = btn.innerText; btn.innerText = "ğŸš€ è³‡æ–™å‚³é€ä¸­..."; btn.disabled = true;

        const postData = {
            email, phone, roleId: myRole, ownerName: name,
            receiveTarget: document.getElementById('receive-select').value,
            giveTarget: document.getElementById('give-select').value,
            message: msg, 
            paymentInfo: finalPaymentInfo, // æ•´åˆä»˜æ¬¾è³‡è¨Šå‚³é€
            imageBase64: savedImageBase64,
            method: currentMethod, pickupTime: pTime, address: addr,
            usedFlowers: usedFlowers
        };

        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(postData) });
            const result = await res.json();
            if(result.status === 'success') {
                alert("ğŸ‰ å ±åæˆåŠŸï¼"); location.reload();
            } else {
                alert("âŒ å¤±æ•—ï¼š" + result.message);
                if(!result.message.includes("Email")) location.reload();
            }
        } catch(e) { console.error(e); alert("éŒ¯èª¤:"+e); }
        finally { btn.innerText = txt; btn.disabled = false; }
    };
    // [ç¢ºèªé€å‡º]
    document.getElementById('btn-submit').onclick = async () => {
        const email = document.getElementById('email-input').value;
        const phone = document.getElementById('phone-input').value;
        const name = document.getElementById('name-input').value;
        const msg = document.getElementById('msg-input').value;
        
        // å–è²¨æ–¹å¼èˆ‡åœ°å€é©—è­‰
        let pTime = "", addr = "";
        
        if (currentMethod === 'è‡ªå–') {
            pTime = document.getElementById('self-time').value;
            if(!pTime) return alert("è«‹é¸æ“‡è‡ªå–æ™‚æ®µï¼");
            addr = "äººæ€§ç©ºé–“ (è‡ªå–)";
        } else {
            // --- ğŸšš é‹é€æ¨¡å¼çš„é˜²å‘†æª¢æŸ¥ ---
            pTime = document.getElementById('delivery-time').value;
            addr = document.getElementById('delivery-address').value;
            
            if(!addr) return alert("è«‹è¼¸å…¥é…é€åœ°å€ï¼");
            if(!pTime) return alert("è«‹é¸æ“‡é…é€æ™‚æ®µï¼");

            // 1. æª¢æŸ¥æ˜¯å¦åŒ…å«ã€Œå€ã€çš„é—œéµå­—
            const allowedDistricts = ['ä¸­æ­£å€', 'å¤§å®‰å€', 'ä¿¡ç¾©å€'];
            // æª¢æŸ¥åœ°å€å­—ä¸²ä¸­ï¼Œæ˜¯å¦åŒ…å«ä¸Šè¿°ä»»ä½•ä¸€å€‹é—œéµå­—
            const isDistrictValid = allowedDistricts.some(dist => addr.includes(dist));

            if (!isDistrictValid) {
                return alert("âš ï¸ å¾ˆæŠ±æ­‰ï¼Œé…é€ç¯„åœåƒ…é™ï¼š\nã€ä¸­æ­£å€ã€å¤§å®‰å€ã€ä¿¡ç¾©å€ã€‘\n\nè«‹ç¢ºèªæ‚¨çš„åœ°å€åŒ…å«ä¸Šè¿°è¡Œæ”¿å€åç¨±ï¼Œæˆ–æ˜¯æ”¹é¸è‡ªå–å–”ï¼");
            }
            // ---------------------------
        }

        // ä»˜æ¬¾æ–¹å¼é©—è­‰
        let finalPaymentInfo = "";
        if (currentPayment === 'bank') {
            const bankCode = document.getElementById('pay-input').value;
            if(!bankCode) return alert("è«‹å¡«å¯«åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼ï¼");
            finalPaymentInfo = "æœ«äº”ç¢¼: " + bankCode;
        } else {
            finalPaymentInfo = "Apple Pay (ä½¿ç”¨è€…å›å ±å·²ä»˜æ¬¾)";
        }

        if(!email || !name) return alert("è«‹å¡«å¯«å®Œæ•´è¯çµ¡è³‡æ–™ï¼");
        if(!phone) return alert("è«‹å¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼ï¼");

        const btn = document.getElementById('btn-submit');
        const txt = btn.innerText; btn.innerText = "ğŸš€ è³‡æ–™å‚³é€ä¸­..."; btn.disabled = true;

        const postData = {
            email, phone, roleId: myRole, ownerName: name,
            receiveTarget: document.getElementById('receive-select').value,
            giveTarget: document.getElementById('give-select').value,
            message: msg, 
            paymentInfo: finalPaymentInfo,
            imageBase64: savedImageBase64,
            method: currentMethod, pickupTime: pTime, address: addr,
            usedFlowers: usedFlowers
        };

        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(postData) });
            const result = await res.json();
            if(result.status === 'success') {
                alert("ğŸ‰ å ±åæˆåŠŸï¼"); location.reload();
            } else {
                alert("âŒ å¤±æ•—ï¼š" + result.message);
                if(!result.message.includes("Email")) location.reload();
            }
        } catch(e) { console.error(e); alert("éŒ¯èª¤:"+e); }
        finally { btn.innerText = txt; btn.disabled = false; }
    };
</script>

</body>
</html>
