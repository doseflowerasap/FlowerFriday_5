<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•å‹•ç‰©èŠ±è—äº¤æ›æ´¾å°</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { 
            font-family: 'Microsoft JhengHei', 'Helvetica', sans-serif; 
            background-color: #fdf5e6; 
            color: #4a4a4a; 
            margin: 0; 
            padding: 0; 
            line-height: 1.6;
        }
        
        /* ä¸€é å¼å®¹å™¨ */
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        /* æ¨™é¡Œå€ */
        header {
            background-color: #2c5e2e;
            color: white;
            padding: 40px 20px;
            text-align: center;
        }
        h1 { margin: 0; font-size: 24px; letter-spacing: 2px; }
        .subtitle { font-size: 14px; opacity: 0.9; margin-top: 10px; }

        /* é€šç”¨å€å¡Šæ¨£å¼ */
        section {
            padding: 30px 20px;
            border-bottom: 10px solid #fdf5e6;
        }
        h2 { 
            color: #2c5e2e; 
            font-size: 20px; 
            margin-bottom: 20px; 
            border-left: 5px solid #c0392b;
            padding-left: 10px;
        }
        
        /* --- å€å¡Š 1: è§’è‰²é¸æ“‡ (åˆ—è¡¨å¼) --- */
        .role-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .role-card {
            display: flex;
            align-items: flex-start;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: 0.2s;
            background: #fff;
        }
        .role-card:hover { border-color: #aaa; }
        
        /* é¸ä¸­ç‹€æ…‹ */
        .role-card.selected { 
            border-color: #c0392b; 
            background-color: #fff5f5; 
            box-shadow: 0 4px 10px rgba(192, 57, 43, 0.2);
        }
        /* å·²è¢«é¸èµ°ç‹€æ…‹ */
        .role-card.disabled { 
            opacity: 0.6; 
            background-color: #f9f9f9; 
            cursor: not-allowed; 
            filter: grayscale(1);
        }
        .role-card.disabled::after {
            content: '(å·²é¡æ»¿)';
            color: red;
            font-weight: bold;
            margin-left: auto;
            font-size: 12px;
        }

        .role-icon { font-size: 40px; margin-right: 15px; flex-shrink: 0; }
        .role-info h3 { margin: 0 0 5px 0; font-size: 18px; color: #333; }
        .role-desc { font-size: 13px; color: #666; margin: 0; text-align: justify; }

        /* --- å€å¡Š 3: èŠ±è—å¯¦é©—å®¤ --- */
        .canvas-container { 
            position: relative; 
            width: 100%; 
            height: 350px; 
            background-color: #fffaf0; 
            border: 2px dashed #2c5e2e; 
            border-radius: 10px;
            margin-bottom: 15px; 
            overflow: hidden; 
        }
        .flower-assets { 
            display: flex; 
            gap: 10px; 
            overflow-x: auto; 
            padding: 10px 0; 
        }
        .asset-item { 
            width: 50px; height: 50px; 
            border: 1px solid #ddd; 
            border-radius: 50%; 
            cursor: pointer; 
            flex-shrink: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            background: #fff;
        }
        .draggable-item { position: absolute; cursor: move; font-size: 40px; user-select: none; z-index: 10; }

        /* --- è¡¨å–®æ§åˆ¶ --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; }
        select, input, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 16px;
            background: #fff;
        }
        
        /* é€å‡ºæŒ‰éˆ• */
        .submit-btn {
            width: 100%;
            padding: 15px;
            background-color: #c0392b;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(192, 57, 43, 0.4);
            margin-top: 20px;
        }
        .submit-btn:disabled { background-color: #ccc; box-shadow: none; }

        /* ç°¡å–®çš„è¼‰å…¥å‹•ç•« */
        .loading-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(255,255,255,0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 999;
            flex-direction: column;
        }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div style="font-size:40px;">ğŸ„</div>
    <p>æ­£åœ¨ç¢ºèªè§’è‰²åå–®...</p>
</div>

<div class="container">
    <header>
        <h1>è–èª•å‹•ç‰©èŠ±è—äº¤æ› ğŸŒ¸</h1>
        <div class="subtitle">é¸å€‹è§’è‰²ï¼Œé€å‡ºä¸€æŸç¨ä¸€ç„¡äºŒçš„èŠ±</div>
    </header>

    <section id="section-role">
        <h2>1. è«‹å•ä½ æ˜¯å“ªä½å‹•ç‰©ï¼Ÿ</h2>
        <div id="role-list" class="role-list">
            </div>
    </section>

    <section id="section-match">
        <h2>2. äº¤æ›å¿ƒé¡˜</h2>
        <div class="form-group">
            <label>ä½ å¸Œæœ›æ”¶åˆ°èª°é…çš„èŠ±ï¼Ÿ</label>
            <select id="receive-select">
                <option value="">è«‹é¸æ“‡...</option>
            </select>
        </div>
        <div class="form-group">
            <label>ä½ æƒ³æŠŠä½ çš„èŠ±é€çµ¦èª°ï¼Ÿ</label>
            <select id="give-select">
                <option value="">è«‹é¸æ“‡...</option>
            </select>
        </div>
    </section>

    <section id="section-flower">
        <h2>3. èŠ±è—å¯¦é©—å®¤ ğŸ¨</h2>
        <p style="font-size:13px; color:#666; margin-top:-10px;">é»æ“Šä¸‹æ–¹ç´ æï¼Œæ‹–æ›³ä½ˆç½®ä½ çš„èŠ±æŸ</p>
        
        <div class="canvas-container" id="flower-canvas">
            <span style="position:absolute; top:45%; width:100%; text-align:center; color:#ccc; pointer-events:none;">
                åœ¨é€™è£¡å‰µä½œ<br>(å¯æ‹–æ›³ç§»å‹•)
            </span>
        </div>

        <div class="flower-assets">
            <div class="asset-item" onclick="addItem('ğŸŒ¹')">ğŸŒ¹</div>
            <div class="asset-item" onclick="addItem('ğŸŒ»')">ğŸŒ»</div>
            <div class="asset-item" onclick="addItem('ğŸŒ·')">ğŸŒ·</div>
            <div class="asset-item" onclick="addItem('ğŸŒ¿')">ğŸŒ¿</div>
            <div class="asset-item" onclick="addItem('ğŸŒ¾')">ğŸŒ¾</div>
            <div class="asset-item" onclick="addItem('ğŸŒ¸')">ğŸŒ¸</div>
            <div class="asset-item" onclick="addItem('ğŸ')">ğŸ</div>
            <div class="asset-item" onclick="addItem('ğŸ€')">ğŸ€</div>
            <div class="asset-item" onclick="addItem('âœ¨')">âœ¨</div>
        </div>
        <button onclick="clearCanvas()" style="margin-top:10px; background:none; border:1px solid #ccc; padding:5px 10px; border-radius:15px; font-size:12px;">æ¸…ç©ºé‡ä¾†</button>
    </section>

    <section id="section-info">
        <h2>4. ç¥ç¦èˆ‡è³‡æ–™</h2>
        <div class="form-group">
            <label>çµ¦å°æ–¹çš„è–èª•ç¥ç¦ï¼š</label>
            <textarea id="msg-input" rows="4" placeholder="å¯«ä¸‹æš–å¿ƒçš„è©±..."></textarea>
        </div>
        <div class="form-group">
            <label>é ˜èŠ±æš±ç¨± (çœŸå¯¦å§“åæˆ–æš±ç¨±)ï¼š</label>
            <input type="text" id="name-input" placeholder="ä¾‹å¦‚ï¼šå°æ˜">
        </div>
        <div class="form-group">
            <label>åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼ï¼š</label>
            <input type="text" id="pay-input" placeholder="12345">
        </div>

        <button id="btn-submit" class="submit-btn">ç¢ºèªå ±å</button>
    </section>
</div>

<script>
    // ==========================================
    // âš ï¸ è¨­å®šå€ï¼šè«‹æ›æˆä½ çš„ Google Apps Script ç¶²å€
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/ä½ çš„äº‚ç¢¼ID/exec"; 

    // è§’è‰²è©³ç´°è³‡æ–™ (å°æ‡‰ä½ çš„åœ–ç‰‡)
    // æ³¨æ„ï¼šid å¿…é ˆè·Ÿ Google Sheet è£¡çš„ role_id ä¸€æ¨¡ä¸€æ¨£
    const CHARACTER_DESC = [
        {
            id: 'rabbit',
            icon: 'ğŸ°',
            name: 'å›ºåŸ·çš„å…”å­',
            desc: 'æœ‰è—è‰²çœ¼ç›ï¼Œä¸å–œæ­¡åƒè¶…éå…«å…¬åˆ†çš„èƒ¡è˜¿è””ï¼Œå–œæ­¡åœ¨é›²å±¤å¾ˆåšçš„æ™‚å€™ä¸Šå»æ‰€ï¼Œç„¡èŠçš„æ™‚å€™å–œæ­¡ç®—å¡”ç¾…ã€‚'
        },
        {
            id: 'lion',
            icon: 'ğŸ¦',
            name: 'æµªæ¼«çš„ç…å­',
            desc: 'é’å£¯å¹´ï¼Œæœ‰è‘—æ¯”å¤§éƒ¨åˆ†ç…å­é•·çš„å°¾å·´ã€‚å–œæ­¡åœ¨æ¨¹ä¸‹ä¹˜æ¶¼ï¼Œåœ¨ä¹˜æ¶¼çš„æ™‚å€™å–œæ­¡å¯«è©©ï¼Œä½†ä¸æœƒæ‹¿ç­†ã€‚'
        },
        {
            id: 'cat',
            icon: 'ğŸ±',
            name: 'ç²¾éˆçš„å°è²“',
            desc: 'æœ‰è‘—ç°é»‘è‰²çš„å¤§ç†çŸ³ç´‹ã€éŠ³åˆ©çš„çœ¼ç¥ï¼Œæ˜¯å‰›å‡ºç”Ÿä¸ä¹…çš„è²“å’ªå¯¶å¯¶ã€‚æœ€å–œæ­¡åƒçš„é£Ÿç‰©æ˜¯é®­é­šï¼Œå¤¢æƒ³æ˜¯å¯ä»¥è·³åˆ°ç…å­æ„›ä¹˜æ¶¼çš„æ¨¹ä¸Šï¼Œç„¶å¾Œå¾æ¨¹ä¸Šå¾€ä¸‹çœ‹ä»–ã€‚'
        },
        {
            id: 'elephant',
            icon: 'ğŸ˜',
            name: 'ç„¡æ†‚ç„¡æ…®çš„å¤§è±¡',
            desc: 'ç”Ÿæ€§æ¨‚è§€ã€æ²’æœ‰ç…©æƒ±ï¼Œæ‰€æœ‰çš„å‹•ç‰©éƒ½å–œæ­¡æ‰¾ä»–è«‡å¿ƒï¼Œä½†æ˜¯å¤©ç”Ÿåªæœ‰ä¸‰éš»è…³ã€‚æœ‰å€‹æ²’å‹•ç‰©çŸ¥é“çš„ç§˜å¯†æŠ€èƒ½æ˜¯æœƒèƒŒä¹ä¹ä¹˜æ³•è¡¨ã€‚'
        },
        {
            id: 'owl',
            icon: 'ğŸ¦‰',
            name: 'å°‘ä¸€æ ¹è–çš„è²“é ­é·¹',
            desc: 'é•·å¾—å¾ˆå¸¥ã€å–œæ­¡åƒè¾£ã€‚æœ€å–œæ­¡ç¡è¦ºçš„åœ°æ–¹æ˜¯å…”å­çª©é‚Šï¼Œå¦‚æœæ²’ä¸å°å¿ƒé£›éŒ¯çš„è©±ã€‚'
        },
        {
            id: 'penguin',
            icon: 'ğŸ§',
            name: 'ç†±æ„›ç’°ä¿çš„ä¼éµ',
            desc: 'èµ°è·¯å¾ˆæ…¢ã€ä¸æœƒæ¸¸æ³³ã€‚èˆˆè¶£æ˜¯ç™¼æ˜å¥½åƒçš„ç´ é£Ÿèœå–®ï¼Œå¸Œæœ›èœå–®å¯ä»¥ç²å¾—å›ºåŸ·å…”å­çš„èªå¯ï¼Œä¹Ÿå¸Œæœ›æœ‰ä¸€å¤©å¯ä»¥çœ‹åˆ°æ²’æœ‰åƒåœ¾çš„æµ·ç˜ã€‚'
        }
    ];

    let myRole = null;
    
    // --- 1. åˆå§‹åŒ–èˆ‡è®€å–è³‡æ–™ ---
    window.onload = async function() {
        try {
            // å¾ Google Sheet æŠ“å–ç›®å‰çš„è¢«é¸å–ç‹€æ…‹
            const res = await fetch(API_URL);
            const sheetData = await res.json();
            
            // éš±è— Loading
            document.getElementById('loading').style.display = 'none';

            // æ¸²æŸ“ä»‹é¢
            renderRoleList(sheetData);
            renderSelectOptions();

        } catch (e) {
            alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
            console.error(e);
        }
    };

    function renderRoleList(sheetData) {
        const container = document.getElementById('role-list');
        container.innerHTML = '';

        CHARACTER_DESC.forEach(char => {
            // æª¢æŸ¥ Google Sheet å›å‚³çš„è³‡æ–™ä¸­ï¼Œé€™å€‹è§’è‰²æ˜¯å¦è¢«é¸èµ° (taken)
            // é€™è£¡åšä¸€å€‹ç°¡å–®çš„æ¯”å°ï¼šæ‰¾ id ç›¸åŒçš„
            const status = sheetData.find(d => d.id === char.id);
            const isTaken = status ? status.taken : false;

            // å»ºç«‹å¡ç‰‡ HTML
            const card = document.createElement('div');
            card.className = `role-card ${isTaken ? 'disabled' : ''}`;
            card.onclick = () => {
                if(!isTaken) selectRole(card, char.id);
            };

            card.innerHTML = `
                <div class="role-icon">${char.icon}</div>
                <div class="role-info">
                    <h3>${char.name}</h3>
                    <p class="role-desc">${char.desc}</p>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function renderSelectOptions() {
        const rSelect = document.getElementById('receive-select');
        const gSelect = document.getElementById('give-select');
        
        CHARACTER_DESC.forEach(char => {
            const option = `<option value="${char.id}">${char.icon} ${char.name}</option>`;
            rSelect.innerHTML += option;
            gSelect.innerHTML += option;
        });
    }

    // --- 2. äº’å‹•é‚è¼¯ ---
    function selectRole(element, id) {
        // ç§»é™¤å…¶ä»–äººçš„é¸å–ç‹€æ…‹
        document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
        // åŠ ä¸Šè‡ªå·±çš„é¸å–ç‹€æ…‹
        element.classList.add('selected');
        myRole = id;
    }

    // --- 3. èŠ±è—ç•«å¸ƒé‚è¼¯ ---
    const canvas = document.getElementById('flower-canvas');
    
    function addItem(emoji) {
        const el = document.createElement('div');
        el.className = 'draggable-item';
        el.innerText = emoji;
        
        // éš¨æ©Ÿä½ç½®
        el.style.left = (Math.random() * 60 + 20) + '%';
        el.style.top = (Math.random() * 60 + 20) + '%';
        
        makeDraggable(el);
        canvas.appendChild(el);
    }

    function makeDraggable(el) {
        let isDragging = false;
        
        // æ»‘é¼ /æ‰‹æŒ‡æŒ‰ä¸‹
        const startDrag = (e) => {
            isDragging = true;
            el.style.zIndex = 1000;
        };
        // ç§»å‹•
        const moveDrag = (e) => {
            if (!isDragging) return;
            e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿæ»¾å‹•
            
            // å–å¾—æ¸¸æ¨™/æ‰‹æŒ‡åº§æ¨™
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            // è¨ˆç®—ç›¸å°æ–¼ç•«å¸ƒçš„ä½ç½®
            const rect = canvas.getBoundingClientRect();
            el.style.left = (clientX - rect.left - 20) + 'px';
            el.style.top = (clientY - rect.top - 20) + 'px';
        };
        // æ”¾é–‹
        const endDrag = () => { isDragging = false; el.style.zIndex = ''; };

        el.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', moveDrag);
        document.addEventListener('mouseup', endDrag);

        el.addEventListener('touchstart', startDrag);
        document.addEventListener('touchmove', moveDrag, { passive: false });
        document.addEventListener('touchend', endDrag);
    }

    function clearCanvas() {
        canvas.innerHTML = '<span style="position:absolute; top:45%; width:100%; text-align:center; color:#ccc; pointer-events:none;">åœ¨é€™è£¡å‰µä½œ<br>(å¯æ‹–æ›³ç§»å‹•)</span>';
    }

    // --- 4. é€å‡ºè³‡æ–™ ---
    document.getElementById('btn-submit').onclick = async () => {
        // é©—è­‰
        if (!myRole) return alert("è«‹åœ¨ç¬¬ 1 å€é¸æ“‡ä½ çš„è§’è‰²ï¼");
        const receive = document.getElementById('receive-select').value;
        const give = document.getElementById('give-select').value;
        const name = document.getElementById('name-input').value;
        const msg = document.getElementById('msg-input').value;
        const pay = document.getElementById('pay-input').value;

        if(!receive || !give || !name || !pay) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™å–”ï¼");

        // æŒ‰éˆ•é–å®š
        const btn = document.getElementById('btn-submit');
        btn.innerText = "æ­£åœ¨å‚³é€...";
        btn.disabled = true;

        const postData = {
            roleId: myRole,
            ownerName: name,
            receiveTarget: receive,
            giveTarget: give,
            message: msg,
            paymentInfo: pay
        };

        try {
            // ä½¿ç”¨ no-cors æ¨¡å¼æˆ–æ˜¯æ¨™æº– POST
            // æ³¨æ„ï¼šApps Script çš„ doPost å¿…é ˆæ­£ç¢ºè™•ç† OPTIONS è«‹æ±‚æˆ–ä½¿ç”¨ text/plain
            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(postData)
            });
            const result = await res.json();
            
            if(result.status === 'success') {
                alert("ğŸ‰ å ±åæˆåŠŸï¼æˆ‘å€‘æœƒå„˜å¿«é€šçŸ¥ä½ é…å°çµæœã€‚");
                location.reload();
            } else {
                alert("å ±åå¤±æ•—ï¼š" + result.message);
                location.reload(); // é‡æ–°æ•´ç†ä»¥æ›´æ–°ç‹€æ…‹
            }
        } catch(e) {
            console.error(e);
            alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            btn.disabled = false;
            btn.innerText = "ç¢ºèªå ±å";
        }
    };
</script>

</body>
</html>
